<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Simulateur de rotation ‚Äì Interface op√©rationnelle</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    :root{
      --bg:#f0f2f5;--card:#fff;--prim:#2c3e50;--prim-dark:#1a242f;--radius:8px;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Segoe UI",Arial,sans-serif;background:var(--bg);color:#333;}
    h1{text-align:center;color:var(--prim);margin:20px 0 10px}

    #topBar {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      background: var(--card);
      padding: 12px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    #topBar > div {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #topBar label {
      cursor: pointer;
      user-select: none;
    }
    #topBar input[type="number"], #topBar input[type="checkbox"] {
      cursor: pointer;
    }
    #topBar button {
      background: var(--prim);
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }
    #topBar button:hover {
      background: var(--prim-dark);
    }
    #rateMsg {
      color: #555;
      margin-left: 8px;
      min-width: 150px;
    }

    main {
      padding: 20px;
      max-width: 100vw;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      table-layout: fixed;
      word-wrap: break-word;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 13px;
      white-space: nowrap;
    }
    th {
      background: var(--prim);
      color: #fff;
    }
    .ok { color: green; }
    .ko { color: red; }

    tbody tr:hover {
      background: #eef4fb;
    }

    .group-row {
      background-color: #dde6f0;
      font-weight: bold;
      text-align: left;
    }
    table#tblVols th:nth-child(1) { width: 50px}
    table#tblVols th:nth-child(2) { width: 200px; }

    button.details-btn {
  background: var(--prim);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px 10px;
  cursor: pointer;
  font-size: 12px;
}
button.details-btn:hover {
  background: var(--prim-dark);
}
.details-row {
  background: #f9f9f9;
  display: none;
}
.details-row td {
  padding: 5px 10px;
  background-color: #f9f9f9;
  border-top: none;
}

.details-card {
  font-size: 0.9em;
  line-height: 1.4em;
}


.details-row ul {
  list-style: inside disc;
  margin: 0;
  padding-left: 0;
}
.avion-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.avion-group input[type="text"] {
  width: 100%;
  max-width: 150px;
  font-size: 13px;
  padding: 4px 6px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.avion-group label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  cursor: pointer;
  user-select: none;
  color: #444;
  font-weight: 600;
}

.avion-group input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #e74c3c;
  border-radius: 4px;
  flex-shrink: 0;
  transition: box-shadow 0.2s ease;
}

.avion-group input[type="checkbox"]:hover {
  box-shadow: 0 0 5px 2px rgba(231, 76, 60, 0.5);
}

.avion-group input[type="checkbox"]:checked + .label-text {
  color: #c0392b;
  font-weight: 700;
  position: relative;
}

.avion-group input[type="checkbox"]:checked + .label-text::before {
  content: "‚ö†Ô∏è";
  margin-right: 6px;
  position: relative;
  top: 1px;
  font-size: 16px;
}

.passager-input {
  width: 60px;
  text-align: center;
  padding: 4px;
  font-size: 14px;
}
.balisage {
  font-size: 1em;
  font-weight: bold;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.balisage.ko::before {
  content: "‚ö†Ô∏è ";
  margin-right: 2px;
}
.details-card {
  background: #f8f9fa;
  padding: 12px;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  font-size: 0.95em;
}

.cost-line {
  display: flex;
  justify-content: space-between;
  margin: 6px 0;
  padding-bottom: 2px;
  border-bottom: 1px dashed #ccc;
}

.details-icon {
  margin-left: 8px;
  font-size: 0.85em;
  padding: 2px 6px;
  background-color: #e6f0ff;
  border: 1px solid #0077cc;
  border-radius: 5px;
  cursor: pointer;
  color: #0077cc;
  transition: background-color 0.2s;
}

.details-icon:hover {
  background-color: #d0e7ff;
}

table#tblVols th {
  white-space: normal; /* autorise le retour √† la ligne */
  word-wrap: break-word; /* coupe les mots trop longs */
  hyphens: auto; /* coupe les mots avec un tiret si possible */
  line-height: 1.2em; /* un peu plus compact */
  padding: 6px 8px; /* r√©duit un peu le padding pour compenser */
}

table#tblVols th:nth-child(1) {
  width: 40px; /* plus petit pour # */
}

table#tblVols th:nth-child(2) {
  width: 220px; /* plus large pour Route */
}
.ajout-cout-manuel {
  margin-top: 8px;
  padding-top: 6px;
  border-top: 1px dashed #ccc;
}

.form-inline {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  margin-top: 10px;
}

.input-cost,
.input-motif {
  flex: 1 1 150px;
  padding: 6px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
  box-sizing: border-box;
}

.btn-ajouter {
  flex: 0 0 auto;
  padding: 6px 12px;
  background-color: #1976d2;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  white-space: nowrap;
}

.btn-ajouter:hover {
  background-color: #125aa0;
}


</style>
</head>
<body>
  <h1>üõ´ Simulateur de rotation</h1>

  <div id="topBar">
    <div>
      <label for="inpRate">üí± Taux USD ‚Üí MGA</label>
      <input type="number" id="inpRate" min="0" step="1" value="4500" style="width:80px;">
      <button id="btnRate">üîÑ Actualiser</button>
      <span id="rateMsg"></span>
    </div>

    <div>
     <label><input type="checkbox" id="cbIndispoAvion"> Indisponibilit√© d'avion</label>
  <div id="indispo-avion-options" style="display:none; margin-top:10px; border:1px solid #ccc; padding:8px; max-width:350px;">
    <label>
      Avion (type & matricule) :
      <select id="select-indispo-avion" style="width:100%; padding:6px; font-size:14px;">
        <!-- options g√©n√©r√©es en JS -->
      </select>
    </label>
  </div>
     <label><input type="checkbox" id="cbRavitail"> Escale</label>

<div id="escale-fields" style="display: none; margin-top:10px;">
  <label for="typeEscale">Type d‚Äôescale :</label>
  <select id="typeEscale">
    <option value="standard">Sans h√©bergement</option>
    <option value="hebergement">Avec h√©bergement</option>
  </select>

  <br><br>

  <label for="heureEscale">Heure de l‚Äôescale :</label>
  <input type="time" id="heureEscale"/>
</div>

<div id="ravitail-options" style="display:none; margin-top:10px; border:1px solid #ccc; padding:8px; max-width:350px;">
  <label>
    Vol concern√© :
    <select id="select-vol-ravitail"></select>
  </label>
  <br><br>
  <label>
    Escale (a√©roport) :
    <select id="select-escale">
      <!-- options g√©n√©r√©es en JS -->
    </select>
  </label>
</div>

    </div>

    <div>
      <button class="btn" id="btnSimuler">üí° Simuler</button>
    </div>
  </div>

  <main>
    <h2>üìù Param√©trage des vols</h2>
    <table id="tblVols">
      <thead>
        <tr>
          <th>#</th><th>Route</th><th>Date</th><th>Heure d√©part</th><th>Heure arriv√©e</th>
          <th>Avion &amp; Matricule</th>
          <th>Nb passagers</th>
          <th>Prix √©co (MGA)</th><th>Prix affaire (MGA)</th>
          <th>Balisage</th>
        </tr>
      </thead>
      <tbody id="tbodyVols"></tbody>
    </table>
    <div id="resultats" style="margin-top:30px"></div>
  </main>

<script>
let vols = [], durees = {}, carburant = {}, couts = {}, prixUSD = {}, usdToMGA = 4500;
let airportsFromPrices = [];
let sunTimes = {};
const coordonneesAeroports = {
  "ANM": { lat: -16.1639, lon: 49.7738 }, // Antalaha
  "DIE": { lat: -12.3494, lon: 49.2917 }, // Diego Suarez
  "FTU": { lat: -25.0381, lon: 46.9561 }, // Fort Dauphin
  "MJN": { lat: -15.6672, lon: 46.3512 }, // Mahajanga
  "MNJ": { lat: -21.7170, lon: 45.3330 }, // Mananjary
  "MOQ": { lat: -20.2847, lon: 44.3176 }, // Morondava
  "NOS": { lat: -13.3121, lon: 48.3148 }, // Nosy Be
  "SVB": { lat: -14.2786, lon: 50.1747 }, // Sambava
  "TLE": { lat: -23.3834, lon: 43.7285 }, // Toliara
  "TMM": { lat: -18.1095, lon: 49.3925 }, // Toamasina (Tamatave)
  "TNR": { lat: -18.7969, lon: 47.4788 }, // Antananarivo
  "WAI": { lat: -14.8980, lon: 47.9939 }, // Antsohihy
  "WFI": { lat: -21.4416, lon: 47.1117 }, // Fianarantsoa
  "SMS": { lat: -17.0939, lon: 49.8158 }, // Sainte Marie
  "WMN": { lat: -15.4367, lon: 49.6884 }  // Maroantsetra
};
function calculerDistanceNM(code1, code2) {
  const R = 3440.065; // rayon de la Terre en miles nautiques
  const a1 = coordonneesAeroports[code1];
  const a2 = coordonneesAeroports[code2];
  if (!a1 || !a2) return 0;

  const toRad = deg => deg * Math.PI / 180;
  const dLat = toRad(a2.lat - a1.lat);
  const dLon = toRad(a2.lon - a1.lon);
  const lat1 = toRad(a1.lat);
  const lat2 = toRad(a2.lat);

  const a = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return Math.round(R * c);
}


// Formate nombre en string local fr avec s√©paration milliers
const fmt = n => Number(n).toLocaleString('fr-FR', { maximumFractionDigits: 0 });

// Convertit "HH:MM" ou "XhYYmin" en minutes depuis minuit
function parseMinutes(val) {
  if (typeof val === 'number') return val;
  if (typeof val === 'string') {
    val = val.trim();
    let m = val.match(/^(\d{1,2})h(\d{2})min$/i);
    if (m) return (+m[1]) * 60 + (+m[2]);
    m = val.match(/^(\d{1,2}):(\d{2})$/);
    if (m) return (+m[1]) * 60 + (+m[2]);
    const n = Number(val);
    if (!isNaN(n)) return n;
  }
  return NaN;
}

function getAvionsMatricules() {
  const mapAvions = new Map();

  vols.forEach(v => {
    if (v.type_avion && v.matricule) {
      if (!mapAvions.has(v.type_avion)) {
        mapAvions.set(v.type_avion, new Set());
      }
      mapAvions.get(v.type_avion).add(v.matricule);
    }
  });

  // Retourne un tableau [ [type_avion, matricule], ... ] pour chaque combinaison
  const result = [];
  for (const [type, matricules] of mapAvions.entries()) {
    for (const m of matricules) {
      result.push([type, m]);
    }
  }
  return result;
}

const avionsIndisponibles = new Set();

//Escale
const cbRavitail = document.getElementById('cbRavitail');
const divRavitailOptions = document.getElementById('ravitail-options');
const selectVolRavitail = document.getElementById('select-vol-ravitail');
const selectEscale = document.getElementById('select-escale');
const escaleFields = document.getElementById('escale-fields');

  cbRavitail.addEventListener('change', () => {
    if (cbRavitail.checked) {
      escaleFields.style.display = 'block';
    } else {
      escaleFields.style.display = 'none';
    }
  });


// Remplir la liste des vols (avec id et route par exemple)
function remplirSelectVols() {
  selectVolRavitail.innerHTML = vols.map(v =>
    `<option value="${v.id}">${v.id} (${v.depart}‚Üí${v.arrivee})</option>`
  ).join('');
}

// Remplir la liste des codes a√©roport
function remplirSelectAeroports() {
  const aeroports = Object.keys(coordonneesAeroports).sort();
  selectEscale.innerHTML = aeroports.map(code =>
    `<option value="${code}">${code}</option>`
  ).join('');
   // Force la s√©lection sur la premi√®re option
  if (aeroports.length > 0) {
    selectEscale.value = aeroports[0];
    // Puis d√©clenche l'√©v√©nement "change" pour mettre √† jour ravitaillementData.escaleCode
    selectEscale.dispatchEvent(new Event('change'));
  }
}
function mettreAJourRavitaillement() {
  const escaleCode = document.getElementById('select-escale').value;
  const typeEscale = document.getElementById('typeEscale').value;
  const heureEscale = document.getElementById('heureEscale').value;
  const volId = document.getElementById('select-vol-ravitail').value;

  ravitaillementData = {
    escaleCode,
    typeEscale,
    heureEscale,
    volId,
  };

  console.log("Ravitaillement data :", ravitaillementData);
}


// Afficher ou cacher les options quand on coche/d√©coche la checkbox
cbRavitail.addEventListener('change', () => {
  if (cbRavitail.checked) {
    divRavitailOptions.style.display = 'block';
    // Remplir selects si jamais pas fait
    remplirSelectVols();
    remplirSelectAeroports();
    selectVolRavitail.dispatchEvent(new Event('change'));
  } else {
    divRavitailOptions.style.display = 'none';
  }
});
let ravitaillementData = {
  volId: null,
  escaleCode: null,
};

selectVolRavitail.addEventListener('change', () => {
  // Garde la valeur telle quelle, sans parseInt
  ravitaillementData.volId = selectVolRavitail.value;
  console.log("Vol s√©lectionn√© (ID):", ravitaillementData.volId);
});


selectEscale.addEventListener('change', () => {
  ravitaillementData.escaleCode = selectEscale.value;
  console.log("Escalade s√©lectionn√©e (code IATA) :", ravitaillementData.escaleCode);
});


// Calcule l'heure d'arriv√©e en string "HH:MM" √† partir du d√©part et dur√©e vol
function getArrivalTime(v) {
  const key1 = `${v.depart}-${v.arrivee}`;
  const key2 = `${v.arrivee}-${v.depart}`;
  const minutes = parseMinutes(durees[key1] ?? durees[key2]);
  if (isNaN(minutes) || !v.heure_depart || !v.date_depart) return null;
  const departDate = new Date(`${v.date_depart}T${v.heure_depart}`);
  if (isNaN(departDate)) return null;
  const arrivalDate = new Date(departDate.getTime() + minutes * 60000);
  if (isNaN(arrivalDate)) return null;
  return arrivalDate.toTimeString().slice(0, 5);
}

function getDepartTime(v) {
  if (!v.heure_depart || !v.date_depart) return null;
  const departDate = new Date(`${v.date_depart}T${v.heure_depart}`);
  if (isNaN(departDate)) return null;
  return departDate.toTimeString().slice(0, 5);
}

// Converti USD en MGA selon taux
const usd = val => (val || 0) * usdToMGA;

// Charge toutes les donn√©es JSON n√©cessaires
Promise.all([
  fetch('data/vols.json').then(r => r.json()),
  fetch('data/durees.json').then(r => r.json()),
  fetch('data/carburant.json').then(r => r.json()),
  fetch('data/couts.json').then(r => r.json()),
  fetch('data/prix_pax_usd.json').then(r => r.json()).catch(() => ({})),
  fetch('data/sun_times.json').then(r => r.json()).catch(() => ({})),
  fetch('data/hebergement.json').then(r => r.json()).catch(() => ({})) 
]).then(([v, d, carb, c, px, sun,heberg]) => {
  vols = v; durees = d; carburant = carb; couts = c; prixUSD = px; sunTimes = sun;hebergement = heberg;
console.log("üü° sunTimes keys:", Object.keys(sunTimes));

  // Recup√®re la liste des a√©roports des prix
  const set = new Set();
  Object.keys(prixUSD).forEach(route => {
    const [dep, arr] = route.split('-');
    set.add(dep); set.add(arr);
  });
  airportsFromPrices = Array.from(set).sort();

  buildTable();
}).catch(err => alert('Erreur chargement JSON‚ÄØ: ' + err));

function getHebergementCost(codeIATA) {
  if (!hebergement || !hebergement[codeIATA]) return 0;
  return hebergement[codeIATA];
}


// Actualisation taux USD->MGA
function refreshRate() {
  const msg = document.getElementById('rateMsg');
  msg.textContent = 'Chargement‚Ä¶';

  fetch('https://api.exchangerate.host/latest?base=USD&symbols=MGA')
    .then(r => r.json())
    .then(js => {
      const taux = js?.rates?.MGA;
      if (!taux) throw 'R√©ponse API invalide';

      usdToMGA = taux;
      document.getElementById('inpRate').value = Math.round(usdToMGA);
      msg.textContent = 'Taux mis √† jour ‚úîÔ∏è';
      updateAllPrices();
    })
    .catch(() => {
      msg.textContent = '√âchec mise √† jour, entrez manuellement.';
    });
}
document.getElementById('btnRate').onclick = refreshRate;
document.getElementById('inpRate').onchange = e => {
  usdToMGA = +e.target.value || usdToMGA;
  updateAllPrices();
};


function updatePassagers(input) {
  const i = +input.dataset.i;
  const field = input.dataset.f;
  const val = parseInt(input.value, 10) || 0;

  if (!vols[i].nb_passagers || typeof vols[i].nb_passagers !== 'object') {
    vols[i].nb_passagers = { economique: 0, affaire: 0 };
  }

  vols[i].nb_passagers[field === 'eco' ? 'economique' : 'affaire'] = val;
}

/*function ouvrirAjoutVol(groupeCible) {
  const volsHorsGroupe = vols.filter(v => !v.id.startsWith(groupeCible));
  if (volsHorsGroupe.length === 0) {
    alert("Aucun vol √† d√©placer depuis un autre groupe.");
    return;
  }

  const choix = prompt(`D√©placer quel vol dans ${groupeCible} ?\n` +
    volsHorsGroupe.map((v, idx) => `${idx + 1}. ${v.id} (${v.depart}‚Üí${v.arrivee})`).join('\n'));

  const idx = parseInt(choix) - 1;
  if (isNaN(idx) || idx < 0 || idx >= volsHorsGroupe.length) return;

  const volChoisi = volsHorsGroupe[idx];

  // Supprimer l'ancien vol
  const indexDansVols = vols.findIndex(v => v.id === volChoisi.id);
  if (indexDansVols === -1) return;
  vols.splice(indexDansVols, 1);

  // Trouver le dernier index du groupe cible
  const volsDuGroupeCible = vols.filter(v => v.id.startsWith(groupeCible));
  const nouvelIndex = volsDuGroupeCible.length + 1;
  volChoisi.id = `${groupeCible} - ${nouvelIndex}`;

  // Copier typeAvion et matricule depuis un vol du groupe cible (s'il y en a un)
  if (volsDuGroupeCible.length > 0) {
    volChoisi.typeAvion = volsDuGroupeCible[0].typeAvion;
    volChoisi.matricule = volsDuGroupeCible[0].matricule;
  }

  // Ajouter le vol d√©plac√© √† la fin du tableau
  vols.push(volChoisi);

  // Recharger le tableau
  buildTable();
}
*/


// Construit le tableau des vols avec les lignes et s√©lections
function buildTable() {
  const tbody = document.getElementById('tbodyVols');
  tbody.innerHTML = '';
  const airports = airportsFromPrices;

vols.sort((a, b) => a.id.localeCompare(b.id));

  let currentGroup = null;
  let displayIndex = 0;

  vols.forEach(v => {
  const groupMatch = v.id.match(/^(Vol [A-Z])/);
  v.groupe = groupMatch ? groupMatch[1] : 'Autres vols';
});

  vols.forEach((v, i) => {
    if (!airports.includes(v.depart)) v.depart = airports[0] || '';
    if (!airports.includes(v.arrivee)) v.arrivee = airports[0] || '';

    const groupMatch = v.id.match(/^(Vol [A-Z])/);
    const groupe = groupMatch ? groupMatch[1] : 'Autres vols';

    if (groupe !== currentGroup) {
      currentGroup = groupe;
      const trGroup = document.createElement('tr');
      trGroup.classList.add('group-row');
      trGroup.innerHTML = `
  <td colspan="10">
  <div style="display: flex; justify-content: center; align-items: center; width: 100%;">
    <span>${currentGroup}</span>
  </div>
</td>
`;

      tbody.appendChild(trGroup);
    }

    const tr = document.createElement('tr');
    const estIndispo = avionsIndisponibles.has(v.type_avion);
const indicateur = estIndispo ? '<span style="color:red; margin-left:2px;">‚ùåChanger de groupe</span>' : '';

    tr.innerHTML = `
      <td>${displayIndex + 1}
      <button class="btn-echanger" data-i="${i}" onclick="onSelectSwap(this)" style="margin-left:5px;">‚ÜïÔ∏è</button>
  </td>
      <td>
           <select onchange="changerGroupe(${i}, this.value)">
    ${['Vol A', 'Vol B', 'Vol C'].map(g =>
      `<option value="${g}" ${v.id.startsWith(g) ? 'selected' : ''}>${g}</option>`
    ).join('')}
  </select>
        <select data-i="${i}" data-f="depart" onchange="updateRoute(this)">
          ${airports.map(a => `<option ${a === v.depart ? 'selected' : ''}>${a}</option>`).join('')}
        </select>
        ‚Üí
        <select data-i="${i}" data-f="arrivee" onchange="updateRoute(this)">
          ${airports.map(a => `<option ${a === v.arrivee ? 'selected' : ''}>${a}</option>`).join('')}
        </select>
      </td>
      <td><input type="date" value="${v.date_depart}" data-i="${i}" data-f="date_depart" onchange="updateVal(this)"></td>
      <td><input type="time" value="${v.heure_depart}" data-i="${i}" data-f="heure_depart" onchange="updateVal(this)"></td>
      <td class="heureArrivee"></td>
    <td class="avion-group">
  <input type="text" value="${v.type_avion || ''}" data-i="${i}" data-f="type_avion" placeholder="Type avion" onchange="updateVal(this)">
  ${indicateur}
  <input type="text" value="${v.matricule || ''}" data-i="${i}" data-f="matricule" placeholder="Matricule" onchange="updateVal(this)" style="margin-top:4px;">
  <label>
    <input type="checkbox" data-i="${i}" onchange="togglePanne(this)" ${v.est_en_panne ? 'checked' : ''}>
    <span class="label-text">Panne</span>
  </label>
</td>
<td>
  <div style="display: flex; flex-direction: column; gap: 4px;">
    <input class="passager-input" type="number" value="${v.nb_passagers?.economique || 0}" data-i="${i}" data-f="eco" onchange="updatePassagers(this)" placeholder="√âco">
    <input class="passager-input" type="number" value="${v.nb_passagers?.affaire || 0}" data-i="${i}" data-f="aff" onchange="updatePassagers(this)" placeholder="Affaire">
  </div>
</td>

      <td class="priceEco"></td>
      <td class="priceAff"></td>
      <td class="balisage"></td>
       
`;
    tbody.appendChild(tr);
    tr.querySelector(".heureArrivee").textContent = getArrivalTime(v) ?? "‚Äî";

    setPrices(i);
    displayIndex++;
  });
}
//Avion indispo
function remplirSelectIndispoAvion() {
  const select = document.getElementById('select-indispo-avion');
  const avions = getAvionsMatricules(); // fonction qui retourne [[type,avion],...]

  select.innerHTML = `<option value="">-- S√©lectionnez un avion --</option>` +
    avions.map(([type, mat]) => `<option value="${type}">${type} (${mat})</option>`).join('');
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('cbIndispoAvion').addEventListener('change', function() {
    const divOptions = document.getElementById('indispo-avion-options');
    if(this.checked) {
      remplirSelectIndispoAvion();
      divOptions.style.display = 'block';
    } else {
      divOptions.style.display = 'none';
      avionsIndisponibles.clear();
      buildTable();
    }
  });
   document.getElementById('select-escale').addEventListener('change', mettreAJourRavitaillement);
  document.getElementById('typeEscale').addEventListener('change', mettreAJourRavitaillement);
  document.getElementById('heureEscale').addEventListener('input', mettreAJourRavitaillement);

  document.getElementById('select-indispo-avion').addEventListener('change', function() {
    const avionChoisi = this.value;
    if (avionChoisi) {
      avionsIndisponibles.add(avionChoisi);
    }
    buildTable();
  });

  document.getElementById('btnSimuler').onclick = simulate;
});


//
function changerGroupe(index, nouveauGroupe) {
  const vol = vols[index];

  // Modifier l'ID du vol pour refl√©ter le nouveau groupe
  const suffixe = vol.id.split(' ')[2] || index + 1; // ex: "Vol A 3"
  vol.id = `* Vol ${nouveauGroupe} ${suffixe}`;


  // Met √† jour l'affichage complet
  buildTable();
}


function togglePanne(checkbox) {
  const i = +checkbox.dataset.i;
  vols[i].est_en_panne = checkbox.checked;
  
}

let swapFirstIndex = null;

function onSelectSwap(button) {
  const i = +button.dataset.i;

  if (swapFirstIndex === null) {
    // Premier vol s√©lectionn√©
    swapFirstIndex = i;
    button.style.backgroundColor = '#4caf50';
    button.textContent = '‚úîÔ∏è';
    console.log(`Premier vol s√©lectionn√©: ${vols[i].id}`);
  } else if (swapFirstIndex === i) {
    // Annuler la s√©lection
    resetSwapButtons();
  } else {
    // Deuxi√®me vol s√©lectionn√© ‚Üí √©changer les donn√©es
    console.log(`Second vol s√©lectionn√©: ${vols[i].id}`);

    const v1 = vols[swapFirstIndex];
    const v2 = vols[i];

    // √âchange d√©part / arriv√©e
    [v1.depart, v2.depart] = [v2.depart, v1.depart];
    [v1.arrivee, v2.arrivee] = [v2.arrivee, v1.arrivee];

    // √âchange heures d√©part
    [v1.heure_depart, v2.heure_depart] = [v2.heure_depart, v1.heure_depart];

    // √âchange nombre de passagers
    [v1.nb_passagers, v2.nb_passagers] = [v2.nb_passagers, v1.nb_passagers];
    v1.distance_nm = calculerDistanceNM(v1.depart, v1.arrivee);
    v2.distance_nm = calculerDistanceNM(v2.depart, v2.arrivee);

    resetSwapButtons();
    buildTable(); // Reconstruit la table avec mise √† jour compl√®te
  }
}


function resetSwapButtons() {
  swapFirstIndex = null;
  // Reset styles et labels boutons √©change
  document.querySelectorAll('.btn-echanger').forEach(btn => {
    btn.style.backgroundColor = '';
    btn.textContent = '‚ÜïÔ∏è';
  });
}
function getAvionParGroupe(groupe, vols) {
  const volsDuGroupe = vols.filter(v => v.groupe === groupe && v.type_avion && v.matricule);
  if (volsDuGroupe.length > 0) {
    return { type_avion: volsDuGroupe[0].type_avion, matricule: volsDuGroupe[0].matricule };
  }
  // Si aucun avion trouv√© pour ce groupe, retourne vide
  return { type_avion: '', matricule: '' };
}



function updateVal(el) {
  const i = parseInt(el.dataset.i);
  const f = el.dataset.f;
  const nv = el.value;

  if (f === "groupe") {
    vols[i].groupe = nv;

    // R√©cup√®re l‚Äôavion du groupe cible
    const avion = getAvionParGroupe(nv, vols);

    // Met √† jour le type avion + matricule
    vols[i].type_avion = avion.type_avion;
    vols[i].matricule = avion.matricule;

    buildTable();  // Reconstruit le tableau pour mettre √† jour les champs visuellement
    return;
  }

  // Mise √† jour classique
  vols[i][f] = nv;

  // ‚ö°Ô∏è Si on modifie date_depart ou heure_depart, on met √† jour heureArrivee dans la ligne
  if (f === "date_depart" || f === "heure_depart") {
    // Trouver la ligne correspondante (hors groupe)
    const tbody = document.getElementById('tbodyVols');
    const rows = [...tbody.querySelectorAll('tr:not(.group-row)')];
    const row = rows.find(r => {
      const btn = r.querySelector(`button.btn-echanger[data-i="${i}"]`);
      return !!btn;
    });
    if (!row) return;

    const heureArriveeTd = row.querySelector('.heureArrivee');
    if (heureArriveeTd) {
      heureArriveeTd.textContent = getArrivalTime(vols[i]) ?? "‚Äî";
    }
    // Mise √† jour balisage et prix
    setPrices(i);
  }
  }


function updateRoute(sel) {
  vols[+sel.dataset.i][sel.dataset.f] = sel.value;
  setPrices(+sel.dataset.i);
}

// Cherche prix en USD d'un trajet, ou 0 par d√©faut
function getPriceForRoute(dep, arr) {
  return prixUSD[`${dep}-${arr}`]
      || prixUSD[`${arr}-${dep}`]
      || { eco: 0, aff: 0 };
}

// D√©clarations globales (une seule fois)
const airportNameMap = {
  "ANM": "ANTALAHA",
  "DIE": "ANTSIRANANA",
  "FTU": "FARAFANGANA",
  "MJN": "MAHAJANGA",
  "MNJ": "MANANJARY",
  "MOQ": "MORONDAVA",
  "NOS": "NOSY-BE",
  "SVB": "SAMBAVA",
  "TLE": "TOLIARA",
  "TMM": "TOAMASINA",
  "TNR": "ANTANANARIVO",
  "WAI": "ANTSOHIHY",
  "WFI": "FIANARANTSOA",
  "SMS": "SAINTE MARIE"
};

const moisLettres = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];

/**
 * R√©cup√®re les heures de sunrise et sunset pour un code IATA et une date YYYY-MM-DD.
 * @param {string} codeIATA - Code IATA de l'a√©roport.
 * @param {string} dateStr - Date au format 'YYYY-MM-DD'.
 * @returns {object|null} - Objet {sunrise, sunset} ou null si donn√©es absentes.
 */
function getSunTimesForDate(codeIATA, dateStr) {
  if (typeof sunTimes === "undefined") {
    console.warn("sun_times.json n'est pas charg√© ou d√©fini.");
    return null;
  }

  const airportName = airportNameMap[codeIATA.toUpperCase()];
  if (!airportName) {
    console.warn(`Nom complet introuvable pour l'a√©roport : ${codeIATA}`);
    return null;
  }

  const [annee, mois, jourStr] = dateStr.split("-");
  const jour = parseInt(jourStr, 10);
  const moisIndex = parseInt(mois, 10) - 1;
  const moisCode = moisLettres[moisIndex];

  const monthData = sunTimes[airportName]?.[moisCode];
  if (!monthData) {
    console.warn(`Pas de donn√©es pour ${airportName} en ${moisCode}`);
    return null;
  }

  const dayKey = jour <= 14 ? 1 : 15;
  const selectedEntry = monthData.find(e => e.day === dayKey);
  if (!selectedEntry) {
    console.warn(`Pas de donn√©es pour le jour ${dayKey} √† ${airportName} en ${moisCode}`);
    return null;
  }

  return {
    sunrise: selectedEntry.sunrise || null,
    sunset: selectedEntry.sunset || null
  };
}

/**
 * R√©cup√®re l'heure de sunrise pour un code IATA et une date.
 */
function getSunriseForDate(codeIATA, dateStr) {
  const times = getSunTimesForDate(codeIATA, dateStr);
  return times?.sunrise || null;
}

/**
 * R√©cup√®re l'heure de sunset pour un code IATA et une date.
 */
function getSunsetForDate(codeIATA, dateStr) {
  const times = getSunTimesForDate(codeIATA, dateStr);
  return times?.sunset || null;
}

/**
 * R√©cup√®re l'heure de sunrise pour le lendemain d'une date donn√©e.
 */
function getSunriseForNextDay(codeIATA, dateStr) {
  const nextDay = new Date(dateStr);
  nextDay.setDate(nextDay.getDate() + 1);
  const dateFormatted = nextDay.toISOString().slice(0, 10); // YYYY-MM-DD
  return getSunriseForDate(codeIATA, dateFormatted);
}

// Calcule et met √† jour prix et balisage dans la table
function setPrices(i) {
  const v = vols[i];
  const prices = getPriceForRoute(v.depart, v.arrivee);
  v.prix_ticket_eco = usd(prices.eco);
  v.prix_ticket_affaire = usd(prices.aff);

  const arrivalStr = getArrivalTime(v);
  const departStr = getDepartTime(v);
  v.heure_arrivee = arrivalStr || '';

  const allRows = Array.from(document.querySelectorAll('#tbodyVols tr'));
  let volRowCount = -1;
  let targetRow = null;
  for (const r of allRows) {
    if (r.children.length === 1) continue;
    volRowCount++;
    if (volRowCount === i) {
      targetRow = r;
      break;
    }
  }
  if (!targetRow) return;

  const nbEco = parseInt(targetRow.querySelector('input[data-f="eco"]').value) || 0;
  const nbAff = parseInt(targetRow.querySelector('input[data-f="aff"]').value) || 0;

  const prixEcoTotal = v.prix_ticket_eco * nbEco;
  const prixAffTotal = v.prix_ticket_affaire * nbAff;

  targetRow.querySelector('.priceEco').textContent = fmt(prixEcoTotal);
  targetRow.querySelector('.priceAff').textContent = fmt(prixAffTotal);

  const key = `${v.type_avion}-${v.arrivee}`;
  const coutAdema = couts[key]?.balisage_adema || 0;
  const coutAsecna = couts[key]?.balisage_asecna || 0;
  const balisageVal = coutAdema + coutAsecna;

  const sunset = getSunsetForDate(v.arrivee, v.date_depart); // format HH:mm
  const sunrise = getSunriseForNextDay(v.arrivee, v.date_depart); // format HH:mm

  const balisageCell = targetRow.querySelector('.balisage');

  if (!arrivalStr || !departStr || !sunset || !sunrise) {
    console.warn("Balisage fallback ‚Äî donn√©es manquantes : ", {
      arrivalStr, departStr, sunset, sunrise, vol: v
    });
    balisageCell.textContent = balisageVal > 0 ? `Co√ªt balisage : ${fmt(balisageVal)}` : "Pas de co√ªt";
    balisageCell.className = "balisage ok";
    return;
  }

  const arrivalMinutes = parseMinutes(arrivalStr);
  const departMinutes = parseMinutes(departStr);
  const sunsetMinutes = parseMinutes(sunset);
  const sunriseMinutes = parseMinutes(sunrise);

  // On calcule 20 minutes avant le coucher du soleil
  const sunsetMinus20 = sunsetMinutes - 20;

  const isBetweenSunsetAndSunrise = (minutes) => {
    // Nuit : apr√®s coucher du soleil ou avant lever du soleil
    return minutes >= sunsetMinutes || minutes <= sunriseMinutes;
  };

  // Nouvelle condition : d√©part doit √™tre entre sunrise et sunsetMinus20 (plage autoris√©e)
  const isDepartInAllowedWindow = (minutes) => {
    return minutes >= sunriseMinutes && minutes <= sunsetMinus20;
  };

  const depNeedsBalisage = isBetweenSunsetAndSunrise(departMinutes);
  const arrNeedsBalisage = isBetweenSunsetAndSunrise(arrivalMinutes);

  const isDepartAfterSunsetMinus20 = departMinutes > sunsetMinus20;
const isArrivalAfterSunsetMinus20 = arrivalMinutes > sunsetMinus20;


let balisageFinal = balisageVal;
if (isDepartAfterSunsetMinus20 && isArrivalAfterSunsetMinus20) {
  balisageFinal = balisageVal * 2;
}

  // Condition "Pas autoris√©" :  
  // - heure d√©part en dehors de la plage autoris√©e (entre sunrise et sunset-20)
  // - et pas de balisage possible (balisageVal == 0)
  if (!isDepartInAllowedWindow(departMinutes) && balisageVal === 0) {
    balisageCell.textContent = "Pas autoris√©";
    balisageCell.className = "balisage ko";
    return;
  }

  if (depNeedsBalisage || arrNeedsBalisage) {
    if (balisageVal > 0) {
      balisageCell.textContent = `${fmt(balisageFinal)}`;
      balisageCell.className = "balisage ok";
    } else {
      balisageCell.textContent = "Pas autoris√©";
      balisageCell.className = "balisage ko";
    }
  } else {
    balisageCell.textContent = "Pas de co√ªt";
    balisageCell.className = "balisage ok";
  }
  
}



// Mise √† jour de tous les prix √† chaque changement de taux
function updateAllPrices() {
  vols.forEach((_, i) => setPrices(i));
}

function toggleDetails(id) {
  const el = document.getElementById(id);
  if (el.style.display === "none" || el.style.display === "") {
    el.style.display = "block";
  } else {
    el.style.display = "none";
  }
}


// Variable globale pour stocker les co√ªts manuels
const coutsManuels = {};

// Affiche les d√©tails des co√ªts, y compris les co√ªts manuels ajout√©s
function afficherDetails(detailId) {
  const container = document.getElementById(`details-${detailId}`);
  let html = "<ul>";

  // Ajouter les co√ªts manuels
  if (coutsManuels[detailId]) {
    const coutsNonNuls = coutsManuels[detailId].filter(c => c.montant !== 0);
    
    if (coutsNonNuls.length > 0) {
      for (const c of coutsNonNuls) {
        html += `<li><strong>${c.motif}</strong> : ${c.montant.toLocaleString()} MGA</li>`;
      }
    } else {
      html += "<li>Aucun co√ªt manuel</li>";
    }
  } else {
    html += "<li>Aucun co√ªt manuel</li>";
  }

  html += "</ul>";
  container.innerHTML = html;
}


// Ajoute un co√ªt manuel dans coutsManuels, met √† jour l‚Äôaffichage et relance simulate()
function ajouterCoutManuel(detailId) {
  const montantInput = document.getElementById(`customCost-${detailId}`);
  const motifInput = document.getElementById(`customMotif-${detailId}`);
  const montant = parseFloat(montantInput.value);
  const motif = motifInput.value.trim();

  if (!isNaN(montant) && montant > 0 && motif !== '') {
    if (!coutsManuels[detailId]) {
      coutsManuels[detailId] = [];
    }
    coutsManuels[detailId].push({ montant, motif });

    // Vider les champs
    montantInput.value = '';
    motifInput.value = '';
    
    // Mettre √† jour la liste compl√®te des co√ªts manuels dans le DOM
    const ul = document.getElementById(`liste-couts-${detailId}`);
    ul.innerHTML = coutsManuels[detailId].map(c => `<li>${c.motif} : ${c.montant.toLocaleString()} MGA</li>`).join('');

  } else {
    alert("Veuillez entrer un montant valide et un motif.");
  }
  simulate();
}
// Modification dans la fonction simulate() au niveau du calcul des co√ªts totaux
function simulate() {
  if (!vols || !carburant || !couts || !hebergement) {
    console.error('Donn√©es manquantes');
    return;
  }
  const [typeLabel, consoStr] = "ATR72-600|2.5".split('|');
  const conso = parseFloat(consoStr);
  const rav = document.getElementById('cbRavitail').checked;
  const volIdSelectionne = ravitaillementData.volId;
  const escale = ravitaillementData.escaleCode;
const volSelectionne = vols.find(v => v.id === volIdSelectionne);


  let html = '<table><tr><th>#</th><th>Route</th><th>Revenu</th><th>Co√ªt</th><th>B√©n√©fice</th></tr>';
  let revTot = 0, coutTot = 0;
  

  vols.forEach((v, i) => {
    const litres = (v.distance_nm || 0) * conso;
    const prixCarburant = carburant[v.depart] || 0;
    const cCarb = litres * prixCarburant;
    const key = `${v.type_avion}-${v.arrivee}`;
    const cEscal = couts[key] || {};
    const cAtterrissage = (cEscal.atterrissage_adema || 0) + (cEscal.atterrissage_asecna || 0) + (cEscal.atterrissage_ravinala || 0);
    const cBalisage = (cEscal.balisage_adema || 0) + (cEscal.balisage_asecna || 0);
    const cApproche = cEscal.approche_adema || 0;
    const nbPassagersTotal = (v.nb_passagers?.economique || 0) + (v.nb_passagers?.affaire || 0);
    
   let coutHebergement = 0;
   let hebergementUnitCost = 0;
if (
  ravitaillementData &&
  ravitaillementData.typeEscale === 'hebergement' &&
  ravitaillementData.volId === v.id // le vol courant dans la boucle
) {
  hebergementUnitCost = getHebergementCost(escale);
  coutHebergement = hebergementUnitCost*nbPassagersTotal;
  
}
let cAtterrissageEscale = 0;
let cApprocheEscale = 0;
if(
  ravitaillementData &&
  ravitaillementData.typeEscale === 'standard' &&
  ravitaillementData.volId === v.id
){
  const escaleKey = `${v.type_avion}-${escale}`; // exemple: ATR72-600-ANM
  const escaleCouts = couts[escaleKey] || {};

 cAtterrissageEscale =
    (escaleCouts.atterrissage_adema || 0) +
    (escaleCouts.atterrissage_asecna || 0) +
    (escaleCouts.atterrissage_ravinala || 0);

 cApprocheEscale=
    (escaleCouts.approche_adema || 0);
  }

let balisageEscale = 0; // initialis√©

if (
  typeof ravitaillementData !== 'undefined' &&
  ravitaillementData.escaleCode &&
  v.id === volSelectionne?.id &&
  ravitaillementData.heureEscale
) {
  const escale = ravitaillementData.escaleCode;
  const heureEscale = ravitaillementData.heureEscale;

  const sunsetEscale = getSunsetForDate(escale, v.date_depart);
  const sunriseEscale = getSunriseForNextDay(escale, v.date_depart);

  if (sunsetEscale && sunriseEscale) {
    const escaleMin = parseMinutes(heureEscale);
    const sunsetMin = parseMinutes(sunsetEscale);
    const sunriseMin = parseMinutes(sunriseEscale);

    const escaleAfterSunset = escaleMin > (sunsetMin - 20);
    const escaleBeforeSunrise = escaleMin <= sunriseMin;

    const balisageEscaleNeeded = escaleAfterSunset || escaleBeforeSunrise;

    const keyEscale = `${v.type_avion}-${escale}`;
    const coutAdemaEscale = couts[keyEscale]?.balisage_adema || 0;
    const coutAsecnaEscale = couts[keyEscale]?.balisage_asecna || 0;
    const coutBalisageTotalEscale = coutAdemaEscale + coutAsecnaEscale;

    if (balisageEscaleNeeded && coutBalisageTotalEscale > 0) {
      balisageEscale = coutBalisageTotalEscale;
    }
    console.log(`Co√ªts pour cl√© ${keyEscale}:`, couts[keyEscale]);

    console.log('sunsetEscale:', sunsetEscale, 'sunriseEscale:', sunriseEscale);
     console.log(`Balisage escale n√©cessaire pour vol ${v.id} √† l'escale ${escale}: ${fmt(balisageEscale)} MGA`);

  }
}

  console.log(`Co√ªt unitaire h√©bergement: ${hebergementUnitCost}`);
  console.log(`Co√ªt atterrisage escale: ${cAtterrissageEscale}`);
  console.log("ravitaillementData.volId =", ravitaillementData.volId);

   console.log(`Vol s√©lectionn√© pour h√©bergement: ${volIdSelectionne}`, nbPassagersTotal , "Co√ªt h√©bergement:", coutHebergement );
    // Somme des co√ªts manuels ajout√©s
    let coutsManuelsTotal = 0;
    const detailId = `detail-${i}`;
    if (coutsManuels[detailId]) {
      coutsManuelsTotal = coutsManuels[detailId].reduce((sum, c) => sum + c.montant, 0);
    }

    const cTot = cCarb + cAtterrissage + cBalisage + cApproche 
      + (v.est_en_panne ? 200000 : 0)
      + coutHebergement
      + cAtterrissageEscale
      + cApprocheEscale
      + balisageEscale
      + coutsManuelsTotal; // Ajout des co√ªts manuels ici

    const rev = (v.nb_passagers?.economique || 0) * (v.prix_ticket_eco || 0)+ (v.nb_passagers?.affaire || 0) * (v.prix_ticket_affaire);

    const ben = rev - cTot;

    revTot += rev;
    coutTot += cTot;

    html += `
<tr>
  <td>${i + 1}</td>
  <td>${v.depart}‚Üí${v.arrivee}</td>
  <td>${fmt(rev)}</td>
  <td>
    <span>${fmt(cTot)}</span>
    <button class="details-icon" onclick="toggleDetails('${detailId}')">D√©tails</button>
    <div class="details-card" id="${detailId}" style="display: none; max-width: 300px; margin-top: 5px;">
      <div class="cost-line"><span>Prix carburant (${v.depart}) :</span><strong>${prixCarburant.toFixed(2)} MGA/L</strong></div>
      <div class="cost-line"><span>Co√ªt carburant total :</span><strong>${fmt(cCarb)}</strong></div>
      <div class="cost-line"><span>Co√ªt atterrissage :</span><strong>${fmt(cAtterrissage || 0)}</strong></div>
      <div class="cost-line"><span>Co√ªt atterrissage escale :</span><strong>${fmt(cAtterrissageEscale || 0)}</strong></div>
      <div class="cost-line"><span>Co√ªt balisage :</span><strong>${fmt(cBalisage || 0)}</strong></div>
      <div class="cost-line"><span>Co√ªt balisage escale :</span><strong>${fmt(balisageEscale)}</strong></div>
      <div class="cost-line"><span>Co√ªt approche :</span><strong>${fmt(cApproche || 0)}</strong></div>
      <div class="cost-line"><span>Co√ªt approche escale :</span><strong>${fmt(cApprocheEscale || 0)}</strong></div>
      <div class="cost-line"><span>Co√ªt panne :</span><strong>${v.est_en_panne ? fmt(200000) : fmt(0)}</strong></div>
      <div class="cost-line"><span>H√©bergement total :</span><strong>${fmt(coutHebergement)}</strong></div>
      <div class="cost-line">
       <strong>Co√ªts manuels ajout√©s :</strong>
    </div>
<ul class="cost-line" id="liste-couts-${detailId}">
  ${coutsManuels[detailId] ? coutsManuels[detailId]
    .map((c, i) => `<li>${c.motif} : ${c.montant.toLocaleString()} MGA</li>`)
    .join('') : '<li style="color: #888">Aucun co√ªt manuel</li>'}
</ul>

<div class="ajout-cout-manuel" id="container-${detailId}">
  <div class="form-inline">
    <input type="number" id="customCost-${detailId}" placeholder="Montant (MGA)" class="input-cost" />
    <input type="text" id="customMotif-${detailId}" placeholder="Motif du co√ªt" class="input-motif" />
    <button onclick="ajouterCoutManuel('${detailId}')" class="btn-ajouter">Ajouter</button>
  </div>
</div>


    </div>
  </td>
  <td class="${ben >= 0 ? 'ok' : 'ko'}">${fmt(ben)}</td>
</tr>
`;
  });

  const prof = revTot - coutTot;
  html += `</table><p style="margin-top:10px"><strong>R√©sultat global‚ÄØ:</strong> <span class="${prof >= 0 ? 'ok' : 'ko'}">${fmt(prof)} MGA</span></p>`;
  document.getElementById('resultats').innerHTML = html;
}

document.getElementById('btnSimuler').addEventListener('click', () => {
  mettreAJourRavitaillement();
  simulate();
  })

console.log("btnSimuler:", document.getElementById('btnSimuler'));


</script>
<style>
  .selected-row {
    outline: 2px solid var(--prim);
    background-color: #e3f2fd;
  }
</style>
<script>
  let firstSelectedRow = null;

  function selectRow(row, volId) {
    if (firstSelectedRow === row) {
      row.classList.remove("selected-row");
      firstSelectedRow = null;
      return;
    }

    if (!firstSelectedRow) {
      firstSelectedRow = row;
      row.classList.add("selected-row");
    } else {
      // Deuxi√®me s√©lection => on √©change
      swapRows(firstSelectedRow, row);

      // R√©initialisation
      firstSelectedRow.classList.remove("selected-row");
      firstSelectedRow = null;
    }
  }

  function swapRows(row1, row2) {
    const parent = row1.parentNode;
    const row1Index = Array.from(parent.children).indexOf(row1);
    const row2Index = Array.from(parent.children).indexOf(row2);

    if (row1Index < row2Index) {
      parent.insertBefore(row2, row1);
      parent.insertBefore(row1, parent.children[row2Index]);
    } else {
      parent.insertBefore(row1, row2);
      parent.insertBefore(row2, parent.children[row1Index]);
    }

    // √âventuellement : mettre √† jour la structure JS si tu as un tableau de vols
    const id1 = row1.dataset.volId;
    const id2 = row2.dataset.volId;

    const index1 = vols.findIndex(v => v.id === id1);
    const index2 = vols.findIndex(v => v.id === id2);
    if (index1 !== -1 && index2 !== -1) {
      [vols[index1], vols[index2]] = [vols[index2], vols[index1]];
    }
  }

</script>

</body>
</html>
